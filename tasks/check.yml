---

- name: Check the Windows registry for the installation path of the VMware Tools.
  ansible.windows.win_reg_stat:
    path: 'HKLM:\SOFTWARE\VMware, Inc.\VMware Tools'
    name: InstallPath
  register: vmware_tools_install_folder

- name: check version of VMware Tools
  ansible.windows.win_command: .\VMwareToolboxCmd.exe -v
  args:
    chdir: '{{ vmware_tools_install_folder.value }}'
  register: vmware_toolbox_versionstring
  changed_when: false
  when: vmware_tools_install_folder.exists

# TODO make this better with oneliner regex
- name: Set fact for installed VMware Tools version and build.
  ansible.builtin.set_fact:
    installed_vmware_tools_version:
      - "{{ vmware_toolbox_versionstring.stdout_lines[0]|split(' ')|first|reverse|regex_search('\\d+\\.([\\d+.]+)', '\\1')|first|reverse }}"
      - "{{ vmware_toolbox_versionstring.stdout_lines[0]|split(' ')|last|regex_search('\\(build-(\\d+)\\)', '\\1')|first }}"
  when: vmware_toolbox_versionstring.stdout | length > 1

- name: Get content from VMware website.
  ansible.windows.win_uri:
    url: 'https://packages.vmware.com/tools/releases/{{ ansible_role_vmware_tools_version }}/windows/'
    return_content: True
  register: vmware_site_http_output

- name: Set fact for filename for VMware Tools iso.
  ansible.builtin.set_fact:
    vmware_tools_iso_filename: "{{ vmware_site_http_output.content | regex_search('.*(VMware-tools-windows-[\\d.-]+\\.iso).*', '\\1') }}"
  when: vmware_site_http_output.status_code | int  == 200

# TODO make this better with oneliner regex
- name: Set fact for installed VMware Tools version and build.
  ansible.builtin.set_fact:
    installed_vmware_tools_version:
      - "{{ vmware_toolbox_versionstring.stdout_lines[0]|split(' ')|first|reverse|regex_search('\\d+\\.([\\d+.]+)', '\\1')|first|reverse }}"
      - "{{ vmware_toolbox_versionstring.stdout_lines[0]|split(' ')|last|regex_search('\\(build-(\\d+)\\)', '\\1')|first }}"
  when: vmware_toolbox_versionstring.stdout | length > 1

# TODO make this better with oneliner regex
- name: Set fact for available VMware Tools version and build.
  ansible.builtin.set_fact:
    available_vmware_tools_version:
      - "{{ vmware_tools_iso_filename|regex_search('VMware-tools-windows-([\\d.]+)-(\\d+).iso', '\\1')|first }}"
      - "{{ vmware_tools_iso_filename|regex_search('VMware-tools-windows-([\\d.]+)-(\\d+).iso', '\\2')|first }}"
